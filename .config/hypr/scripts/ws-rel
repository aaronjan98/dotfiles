#!/usr/bin/env bash
set -euo pipefail

delta="${1:?use -1 or +1}"
HYPRCTL="${HYPRCTL:-/run/current-system/sw/bin/hyprctl}"

# --- ensure we can talk to Hyprland even from systemd user services ---
if [ -z "${HYPRLAND_INSTANCE_SIGNATURE-}" ]; then
  sig_dir="/run/user/$(id -u)/hypr"
  if [ -d "$sig_dir" ]; then
    sig="$(ls -1 "$sig_dir" 2>/dev/null | head -n1 || true)"
    if [ -n "$sig" ]; then
      export HYPRLAND_INSTANCE_SIGNATURE="$sig"
    fi
  fi
fi

# --- fetch JSON once (and validate) ---
ws_json="$("$HYPRCTL" workspaces -j 2>/dev/null || echo '[]')"
if ! jq -e . >/dev/null 2>&1 <<<"$ws_json"; then
  ws_json='[]'
fi

active_id="$("$HYPRCTL" activeworkspace -j 2>/dev/null | jq -r '.id // 1' 2>/dev/null || echo 1)"
if ! [[ "$active_id" =~ ^[0-9]+$ ]]; then active_id=1; fi

# current domain/slot
if (( active_id <= 9 )); then
  dom=1
  curSlot="$active_id"
  base=0
else
  dom=$(( active_id / 10 ))
  curSlot=$(( active_id % 10 ))
  (( curSlot == 0 )) && curSlot=1
  base=$(( dom * 10 ))
fi

# highest existing workspace id in this domain (from ws_json)
maxExisting="$(
  jq -r --argjson dom "$dom" '
    [ .[]
      | .id
      | if $dom == 1 then
          select(. >= 1 and . <= 9)
        else
          select(. >= ($dom*10 + 1) and . <= ($dom*10 + 9))
        end
    ] | max // 0
  ' <<<"$ws_json" 2>/dev/null || echo 0
)"

# convert to slot
if (( dom == 1 )); then
  maxSlot="$maxExisting"          # 1..9
else
  maxSlot=$(( maxExisting % 10 )) # 1..9
fi

# baseline + clamp
(( maxSlot < 4 )) && maxSlot=4
(( maxSlot > 9 )) && maxSlot=9

# compute next slot (wrap within domain only)
next=$(( curSlot + delta ))
if (( next < 1 )); then next="$maxSlot"; fi
if (( next > maxSlot )); then next=1; fi

# remember last slot
state="${XDG_RUNTIME_DIR:-/tmp}/hypr-domain-last"
mkdir -p "$state"
file="$state/last.txt"
touch "$file"
tmp="$(mktemp)"
awk -v dom="$dom" -v slot="$next" '
  BEGIN{found=0}
  $0 ~ ("^"dom"=") {print dom"="slot; found=1; next}
  {print}
  END{ if(!found) print dom"="slot }
' "$file" > "$tmp"
mv "$tmp" "$file"

# dispatch
if (( dom == 1 )); then
  target="$next"
else
  target=$(( base + next ))
fi

"$HYPRCTL" dispatch workspace "$target" >/dev/null

