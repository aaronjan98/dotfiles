#!/usr/bin/env bash
set -euo pipefail

mode="${1:?use up|down|set}"
arg="${2:-}"

base_domains=(1 2 3)

state_dir="${XDG_RUNTIME_DIR:-/tmp}/hypr-domain-last"
mkdir -p "$state_dir"
last_file="$state_dir/last.txt"          # dom=slot
visited_file="$state_dir/visited.txt"    # one dom per line
touch "$last_file" "$visited_file"

# --- capture hypr state ONCE ---
ws_json="$(hyprctl workspaces -j 2>/dev/null || echo '[]')"
active_id="$(hyprctl activeworkspace -j 2>/dev/null | jq -r '.id // 1')"

if (( active_id <= 9 )); then curDom=1; else curDom=$(( active_id / 10 )); fi
curSlot=$(( active_id % 10 )); (( curSlot == 0 )) && curSlot=1

# Save current slot for current domain
tmp="$(mktemp)"
awk -v dom="$curDom" -v slot="$curSlot" '
  BEGIN{found=0}
  $0 ~ ("^"dom"=") {print dom"="slot; found=1; next}
  {print}
  END{ if(!found) print dom"="slot }
' "$last_file" > "$tmp"
mv "$tmp" "$last_file"

# Domains with windows right now (single jq pass)
win_domains="$(jq -r '
  .[]
  | select(.windows > 0)
  | .id
  | if . <= 9 then 1 else (./10|floor) end
' <<<"$ws_json" | sort -n | uniq || true)"

# Visited domains
vis_domains="$(sort -n "$visited_file" | uniq || true)"

# helper: domain has windows? (check against captured JSON)
domain_has_windows() {
  local dom="$1"
  if (( dom == 1 )); then
    jq -e '[.[] | select(.id>=1 and .id<=9 and .windows>0)] | length>0' \
      <<<"$ws_json" >/dev/null
  else
    local lo=$(( dom*10 + 1 ))
    local hi=$(( dom*10 + 9 ))
    jq -e --argjson lo "$lo" --argjson hi "$hi" \
      '[.[] | select(.id>=$lo and .id<=$hi and .windows>0)] | length>0' \
      <<<"$ws_json" >/dev/null
  fi
}

# prune visited domains that are empty (not base, not current)
tmpv="$(mktemp)"
while read -r dom; do
  [[ -z "${dom:-}" ]] && continue
  if [[ " ${base_domains[*]} " == *" $dom "* ]]; then
    echo "$dom" >> "$tmpv"; continue
  fi
  if (( dom == curDom )); then
    echo "$dom" >> "$tmpv"; continue
  fi
  if domain_has_windows "$dom"; then
    echo "$dom" >> "$tmpv"
  fi
done < <(printf "%s\n" "$vis_domains")
mv "$tmpv" "$visited_file"

# compute maxima (single jq uses captured json)
maxWinDom="$(jq -r '
  [ .[] | select(.windows>0) | (.id | if .<=9 then 1 else (./10|floor) end) ] | max // 0
' <<<"$ws_json")"

maxVisDom="$(sort -n "$visited_file" 2>/dev/null | tail -n1)"
maxVisDom="${maxVisDom:-0}"

maxDom="$curDom"
(( maxDom < 3 )) && maxDom=3
(( maxWinDom > maxDom )) && maxDom="$maxWinDom"
(( maxVisDom > maxDom )) && maxDom="$maxVisDom"

# --- decide target domain ---
case "$mode" in
  set)
    targetDom="$arg"
    echo "$targetDom" >> "$visited_file"
    ;;
  up|down)
    if [[ "$mode" == "down" ]]; then
      targetDom=$(( curDom + 1 ))
    else
      targetDom=$(( curDom - 1 ))
    fi

    if (( targetDom < 1 )); then targetDom="$maxDom"; fi
    if (( targetDom > maxDom )); then targetDom=1; fi

    echo "$targetDom" >> "$visited_file"
    ;;
  *)
    echo "bad mode"; exit 2 ;;
esac

# restore last slot in target domain (default 1)
targetSlot="$(awk -F= -v dom="$targetDom" '$1==dom{print $2}' "$last_file" | tail -n1)"
[[ -z "${targetSlot:-}" ]] && targetSlot=1
(( targetSlot < 1 )) && targetSlot=1
(( targetSlot > 9 )) && targetSlot=9

# compute workspace id
if (( targetDom == 1 )); then
  targetWs="$targetSlot"
else
  targetWs=$(( targetDom*10 + targetSlot ))
fi

hyprctl dispatch workspace "$targetWs"

